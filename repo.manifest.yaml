name: bytefold
mission: "Multi-format archive reader/writer with deterministic safety for Node, Deno, Bun, and Web."
public_api:
  entrypoints:
    npm:
      - "."
      - "./archive"
      - "./compress"
      - "./zip"
      - "./tar"
      - "./node"
      - "./node/zip"
      - "./deno"
      - "./bun"
      - "./web"
    jsr:
      - "."
      - "./archive"
      - "./compress"
      - "./zip"
      - "./tar"
      - "./deno"
      - "./bun"
      - "./web"
commands:
  check: "npm run check"
  test: "npm run test"
  test_browser: "npm run test:browser"
  unicode_check: "npm run unicode:check"
  fixture_hashes_check: "npm run fixtures:hashes:check"
  build: "npm run build"
invariants:
  - "Runtime dependencies count is zero; package is ESM-only and requires Node >= 24."
  - "TypeScript strict mode remains enabled."
  - "Default entrypoints do not import node:* at module evaluation."
  - "Emitted Uint8Array chunks are immutable after enqueue, including under chunking adversary inputs."
  - "Streaming decompression is invariant to input chunking for gzip, bzip2, and xz (including BCJ)."
  - "Mutation harness applies deterministic byte-level mutations across bytes/stream/file/url boundaries for zip/tar/gz/bz2/xz inputs; failures surface typed errors with schema-valid toJSON(), successes return schema-valid audits."
  - "Third-party ZIP and TAR fixtures open, list, and audit cleanly with provenance + size bounds."
  - "Security-sensitive + third-party fixture bytes are pinned in test/fixtures/security-fixture-hashes.json; npm run check fails on missing, unexpected, or changed hashes with explicit diff output."
  - "npm run format:check ignores Playwright artifact directories (test-results/, playwright-report/) so browser smoke artifacts cannot cause false formatting failures in npm run check."
  - "Gzip header options (FEXTRA/FNAME/FCOMMENT) are parsed; FNAME yields the entry name even when extra fields are present, consistently across runtimes."
  - "Gzip FHCRC headers are validated when present; mismatches throw typed errors."
  - "Decompression output ceilings enforce maxTotalDecompressedBytes for gzip/deflate/brotli/zstd and fail with COMPRESSION_RESOURCE_LIMIT without emitting beyond the limit."
  - "Seekable ZIP preflight enforces EOCD/central-directory ceilings before full buffering, rejects multi-disk archives, and stays bounded in HTTP range requests/bytes."
  - "Seekable ZIP over HTTP Range is used for list + single-entry extract and stays bounded without full downloads when Range is supported (tests assert total bytes ≤ ceil(size/16) and request count ≤ 1 + ceil((size/16)/64KiB) + 2)."
  - "HTTP Range sessions pin validators; If-Range is sent only with strong ETags (never weak ETag/Last-Modified), 200 responses to ranged requests with If-Range are treated as resource changed, and Content-Encoding responses are rejected. Snapshot policy require-strong-etag fails without a strong validator, while best-effort proceeds without If-Range. (specs: specs/http/rfc9110-if-range.md, specs/http/rfc9110-accept-encoding.md; tests: test/zip-url-seekable-budget.test.ts, test/deno.smoke.ts, test/bun.smoke.ts)"
  - "HTTP header-only range failures fail fast by aborting request bodies before payload consumption; slow-body adversarial servers remain bounded (<= 4096 bytes served) for range-unsupported and content-encoding rejection paths. (tests: test/zip-url-seekable-budget.test.ts, test/deno.smoke.ts, test/bun.smoke.ts)"
  - "HTTP 206 bodies must match the requested range length exactly; truncated or overrun bodies fail with typed bad-response errors. (tests: test/zip-url-seekable-budget.test.ts, test/bun.smoke.ts, test/deno.smoke.ts)"
  - "XZ Index VLI parsing is chunk-boundary safe, including multi-byte uncompressed sizes."
  - "XZ streaming decode supports padding + concatenation and validates checks (none/CRC32/CRC64/SHA-256)."
  - "XZ supports filters LZMA2, Delta, BCJ x86/PowerPC/IA64/ARM/ARM-Thumb/SPARC/ARM64/RISC-V; unsupported filters/checks throw typed errors."
  - "Mixed XZ filter chains (Delta -> BCJ -> LZMA2) decode correctly with filters applied in reverse order."
  - "XZ BCJ filters enforce property sizing/alignment and cannot be the last filter."
  - "XZ BCJ start offset properties are stream-relative and reset at each concatenated stream."
  - "XZ corruption yields typed errors and extraction is atomic for corrupted streams."
  - "XZ resource ceilings are enforced (buffer + dictionary + Index limits)."
  - "XZ preflight scanning bounds Index parsing without per-record allocations."
  - "Seekable XZ preflight enforces Index limits before full buffering."
  - "Seekable XZ preflight enforces dictionary limits before full buffering (bounded block-header scan)."
  - "Seekable XZ preflight HTTP failures map to specific ARCHIVE_HTTP_* codes with context.httpCode preserving the originating HTTP failure class. (tests: test/xz-http-error-mapping.test.ts, test/xz-seekable-preflight.test.ts, test/deno.smoke.ts, test/bun.smoke.ts)"
  - "Seekable XZ preflight success path is bounded in HTTP range requests/bytes and reports incomplete scans when block header limits are exceeded without blocking decode."
  - "Report + error JSON schemas are versioned and validated."
  - "Public export surface matches the manifest snapshot."
  - "TypeScript declaration surface for every npm/jsr public entrypoint matches the committed snapshot manifest; intentional surface breaks in ALPHA require snapshot updates and explicit CHANGELOG entries, and V1+ will introduce stricter migration discipline."
  - "npm pack payload obeys allowlist/denylist policy: runtime artifacts plus contract metadata (SPEC.md) and JSON schemas (schemas/*.json) only; repo-internal indexes (docs/REPO_INDEX.*) and internal sources are excluded."
  - "Normalize safe mode is deterministic and lossless mode preserves bytes where documented."
  - "extractAll blocks path traversal."
  - "openArchive auto-detects documented formats; tar.br requires an explicit hint."
  - 'openArchive(...) accepts Blob/File inputs (inputKind: "blob"); ZIP on Blob is seekable via random access (slice reads) while non-ZIP Blob inputs are bounded by input limits.'
  - 'Web adapter URL inputs (@ismail-elkorchi/bytefold/web) are HTTPS-only and always full-fetch bytes (no HTTP range sessions); the fetch path enforces input-size limits and preserves inputKind: "url".'
  - "Browser smoke verifies web entrypoint behavior in real Chromium/Firefox/WebKit: Blob ZIP roundtrip, ZIP/TAR writer roundtrip, and URL maxInputBytes abort remains bounded without HTTP Range requests."
  - "Zip64 boundary parsing is deterministic around 32-bit/64-bit limits: EOCD sentinel combinations requiring Zip64 must provide valid locator/record structures, malformed Zip64 extra fields reject with typed ZIP_BAD_ZIP64, and >4GiB central-directory offsets are never truncated to 32-bit values."
  - "Deterministic property tests harden parser boundaries: TAR octal/NUL/space numeric fields, ZIP EOCD comment-length mutations, gzip optional header sections, and web URL maxInputBytes abort paths are fuzzed with fixed seeds and bounded runs."
  - "Unicode Trojan Source directionality controls are blocked by repository scanning: tracked text files must not contain bidi override/isolation control code points, and violations fail npm run check with file/line/codepoint diagnostics."
trust_boundaries:
  trusted:
    - "src/** runtime code"
    - "test/** (offline fixtures only)"
  untrusted:
    - "archive bytes and streams"
    - "entry names and metadata"
    - "user-provided file paths"
unicode_casefold:
  version: "17.0.0"
  file: "specs/unicode/CaseFolding-17.0.0.txt"
  policy: "Full case folding (C + F); Turkic (T) excluded"
migration_policy: "ALPHA (0.x): breaking changes are allowed and codemods are not required; V1+ will introduce formal migration discipline."
